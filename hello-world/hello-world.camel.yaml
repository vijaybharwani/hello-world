- rest:
    id: accounts-api
    description: Accounts API
    path: /accounts
    post:
      - id: post-fa09
        path: /
        to: direct:new-account
- route:
    id: route-e42a
    description: Open New Account Route
    from:
      id: from-5726
      description: Direct
      uri: direct
      parameters:
        name: new-account
      steps:
        - setProperty:
            id: setProperty-5792
            description: Request
            name: requestPayload
            expression:
              datasonnet:
                id: datasonnet-ca44
                expression: payload
                bodyMediaType: application/json
                outputMediaType: application/java
                resultType: java.util.HashMap
        - bean:
            id: bean-109f
        - to:
            id: to-1a11
            description: Generate Token
            uri: direct
            parameters:
              name: generate-token
        - to:
            id: to-b432
            description: Get Person By Name
            uri: direct
            parameters:
              name: get-person-by-name
        - choice:
            id: choice-0d57
            when:
              - id: when-1303
                description: Person Found
                expression:
                  datasonnet:
                    id: datasonnet-6f1a
                    expression: (std.length(payload)) > 0
                steps:
                  - log:
                      id: log-564f
                      message: Person Found
                  - to:
                      id: to-6738
                      description: Create Account
                      uri: direct
                      parameters:
                        name: create-account
            otherwise:
              id: otherwise-a0fe
              description: Not Found
              steps:
                - log:
                    id: log-41ed
                    message: Person Not Found
                - to:
                    id: to-e7b9
                    description: KYC Check
                    uri: direct
                    parameters:
                      name: kyc-check
                - choice:
                    id: choice-8c47
                    when:
                      - id: when-3ff2
                        description: KYC Validation Pass
                        expression:
                          ognl:
                            id: ognl-c43b
                            expression: request.body.valid == true
                        steps:
                          - log:
                              id: log-f29e
                              message: KYC Valid
                          - to:
                              id: to-5c9c
                              description: Create Person
                              uri: direct
                              parameters:
                                name: create-person
                          - to:
                              id: to-b6e3
                              description: Create Account
                              uri: direct
                              parameters:
                                name: create-account
                          - transform:
                              id: transform-e680
                              expression:
                                datasonnet:
                                  id: datasonnet-5873
                                  expression: |-
                                    { "dummy" : 
                                        {
                                      "uSDocumentedIndicator": true,
                                      "identifiers": [
                                        {
                                          "number": "111111111",
                                          "schemeName": "SocialSecurityNumber",
                                          "issuer": "US",
                                          "issueDate": "2022-04-17",
                                          "expirationDate": "2022-04-17"
                                        }
                                      ],
                                      "name": payload.name,
                                      "shortName": "Jane Birkin",
                                      "relatedParties": [
                                        {
                                          "partyId": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                                          "partyType": "Person",
                                          "partyName": "Jane Birkin",
                                          "partyRelationType": "Owner",
                                          "ownershipPercentage": "0.7"
                                        }
                                      ],
                                      "postalAddresses": [
                                        {
                                          "addressType": "Postal",
                                          "addressPurpose": "Billing",
                                          "primaryIndicator": true,
                                          "department": "A",
                                          "subDepartment": "B",
                                          "streetName": "Main Street",
                                          "firstCrossStreetName": "Elm Street",
                                          "secondCrossStreetName": "Oak Street",
                                          "buildingNumber": "123",
                    otherwise:
                      id: otherwise-3590
                      steps:
                        - throwException:
                            id: throwException-83d2
                            description: Throw Exception - KYC Validation Failed
                            message: KYC Validation Failed
                            exceptionType: java.lang.RuntimeException
- route:
    id: route-ec6c
    description: KYC Validation Flow
    nodePrefixId: route-98f
    from:
      id: from-606f
      description: KYC Check Flow
      uri: direct
      parameters:
        name: kyc-check
      steps:
        - log:
            id: log-a35e
            message: ${body}
        - choice:
            id: choice-0a07
            when:
              - id: when-4434
                expression:
                  ognl:
                    id: ognl-8702
                    expression: properties.requestPayload.name.length < 5
                steps:
                  - log:
                      id: log-aec1
                      message: Name size is less than 5
                  - setBody:
                      id: setBody-129d
                      expression:
                        datasonnet:
                          id: datasonnet-99f1
                          expression: '{"valid":true}'
                          bodyMediaType: application/json
                          outputMediaType: application/java
                          resultType: java.util.HashMap
                  - log:
                      id: log-a70d
                      message: ${body}
                  - transform:
                      id: transform-554d
                      expression:
                        datasonnet:
                          id: datasonnet-5bd4
            otherwise:
              id: otherwise-d7d3
              steps:
                - log:
                    id: log-c4e3
                    message: Name size is greater than 5
                - setBody:
                    id: setBody-af0d
                    expression:
                      datasonnet:
                        id: datasonnet-c72f
                        expression: '{"valid":false}'
                        bodyMediaType: application/json
                        outputMediaType: application/java
                        resultType: java.util.HashMap
- route:
    id: route-5e0f
    description: Create Account
    nodePrefixId: route-f7c
    from:
      id: from-99be
      description: Create Account
      uri: direct
      parameters:
        name: create-account
      steps:
        - log:
            id: log-83ad
            message: Account Created
- route:
    id: route-5e6b
    description: Create Person
    nodePrefixId: route-b7b
    from:
      id: from-4296
      description: Create Person
      uri: direct
      parameters:
        name: create-person
      steps:
        - log:
            id: log-df3d
            message: Creating Person
        - setBody:
            id: setBody-8975
            expression:
              datasonnet:
                id: datasonnet-aaef
                expression: cml.exchangeProperty('requestPayload')
                bodyMediaType: application/java
                outputMediaType: application/java
        - log:
            id: log-e8a4
            message: ${body}
        - setBody:
            id: setBody-0eba
            expression:
              datasonnet:
                id: datasonnet-875f
                expression: |-
                  {
                    "uSDocumentedIndicator": true,
                    "identifiers": [
                      {
                        "number": "111111111",
                        "schemeName": "SocialSecurityNumber",
                        "issuer": "US",
                        "issueDate": "2022-04-17",
                        "expirationDate": "2022-04-17"
                      }
                    ],
                    "name": payload.name,
                    "shortName": "Jane Birkin",
                    "relatedParties": [
                      {
                        "partyId": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                        "partyType": "Person",
                        "partyName": "Jane Birkin",
                        "partyRelationType": "Owner",
                        "ownershipPercentage": "0.7"
                      }
                    ],
                    "postalAddresses": [
                      {
                        "addressType": "Postal",
                        "addressPurpose": "Billing",
                        "primaryIndicator": true,
                        "department": "A",
                        "subDepartment": "B",
                        "streetName": "Main Street",
                        "firstCrossStreetName": "Elm Street",
                        "secondCrossStreetName": "Oak Street",
                        "buildingNumber": "123",
                        "buildingName": "Chicago Tower",
                        "floor": "10",
                        "postBox": "CHI456",
                        "room": "22",
                        "postCode": "60601",
                        "townName": "Chicago",
                        "townLocationName": "Cook",
                        "districtName": "Illinois",
                        "countrySubDivision": "Cook County",
                        "countrySubDivisionCode": "US-IL",
                        "country": "US",
                        "addressLine": [
                          "123 Main Street, Suite 23"
                        ]
                      }
                    ],
                    "residenceType": "Domestic",
                    "taxInformation": {
                      "tIN": "111-22-3333",
                      "taxIdType": "SSN",
                      "tINStatus": "Valid",
                      "taxStatus": "Valid",
                      "forms": [
                        {
                          "formName": "W-9",
                          "expirationDate": "2022-04-17"
                        }
                      ],
                      "regulations": [
                        {
                          "name": "Chapter4",
                          "section": "1471"
                        }
                      ],
                      "withholdings": [
                        {
                          "withholdingTaxType": "NonResidentAlienTax",
                          "withholdingRate": "0.7",
                          "withholdingAmount": "100"
                        }
                      ],
                      "countrySubDivision": "Oregon",
                      "countrySubDivisionCode": "AR-B",
                      "country": "US",
                      "supplementaryData": {}
                    },
                    "powerOfAttorney": {
                      "jurisdiction": {
                        "countrySubdivision": "Oregon",
                        "townName": "Tualatin",
                        "country": "US"
                      },
                      "documentId": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                      "documentReference": "string",
                      "version": "string",
                      "signOffDate": "2022-04-17",
                      "issueDate": "2022-04-17",
                      "purpose": "string",
                      "fromDateTime": "2022-04-17T08:00:00Z",
                      "upToDateTime": "2022-04-17T08:00:00Z",
                      "authorizedPerson": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                      "authorizedAccount": "0dd926fe-1ca2-11ed-861d-0242ac120002"
                    },
                    "supplementaryData": {},
                    "restrictions": [
                      {
                        "name": "externalTransferAllowed",
                        "restrictionPurpose": "This is a description.",
                        "validFrom": "2022-04-17",
                        "validUntil": "2022-04-17"
                      }
                    ],
                    "placeAndDateOfBirth": {
                      "countrySubdivision": "Oregon",
                      "townName": "Tualatin",
                      "country": "US",
                      "birthDate": "2022-04-17"
                    },
                    "contact": {
                      "structuredName": {
                        "firstName": "Jane",
                        "lastName": "Birkin"

                      },
                      "name": "Jane Birkin",
                      "phones": [
                        {
                          "number": "+1-415-731359",
                          "extension": "strin",
                          "phoneType": "string",
                          "phonePurpose": "string",
                          "primaryIndicator": true,
                          "preferredHourOfDay": {
                            "hour": "12",
                            "timeZone": "Pacific"
                          }
                        }
                      ],
                      "emails": [
                        {
                          "emailAddress": "string",
                          "emailPurpose": "Statements",
                          "primaryIndicator": true
                        }
                      ],
                      "jobTitle": "Head of Documentation",
                      "department": "Sales",
                      "preferredMethod": "Email",
                      "preferredLanguage": "English"
                    },
                    "headOfHousehold": true,
                    "civilStatus": "Single",
                    "structuredName": {
                      "firstName": "Jane",
                      "middleName": "J",
                      "lastName": "Birkin"
                    },
                    "gender": "Male",
                    "profession": "Technology",
                    "jobTitle": "Head of Documentation",
                    "residentialStatus": "Permanent",
                    "minorIndicator": true,
                    "citizenships": [
                      {
                        "country": "US"
                      }
                    ],
                    "countryOfResidence": "US",
                    "profile": {
                      "riskLevel": "Permanent",
                      "creditReview": {
                        "frequency": {
                          "cycle": "Monthly",
                          "every": 999
                        },
                        "lastReviewDate": "2022-04-17T08:00:00Z",
                        "nextReviewDate": "2022-04-17T08:00:00Z",
                        "creditQuality": "UpperMediumGrade",
                        "creditScore": 0
                      },
                      "creditBureauReportCode": "string",
                      "previousFinancialInstitution": "Jane Birkin",
                      "referredByWhom": "Jane Birkin",
                      "moneyLaunderingCheck": "AuthorizedCredit",
                      "knowYourCustomerCheck": "Ordinary",
                      "timeAtCurrentAddress": {
                        "unit": "Months",
                        "value": 999
                      },
                      "sourceOfWealth": "This is a description.",
                      "politicalAffiliation": "string",
                      "lostCustomerDate": "2022-04-17",
                      "lostCustomerReason": "Deceased",
                      "customerConductClassification": "string",
                      "familyMedicalInsuranceIndicator": true,
                      "salaryRange": {
                        "minAmount": "100",
                        "maxAmount": "100"
                      },
                      "employmentStatus": "string",
                      "vIPStatus": "Elite",
                      "employments": [
                        {
                          "employingPartyName": "Jane Birkin",
                          "jobTitle": "Head of Documentation",
                          "employeeTerminationIndicator": false,
                          "lengthOfEmployment": {
                            "unit": "Months",
                            "value": 999
                          },
                          "endDate": "2022-04-17",
                          "place": {
                            "countrySubdivision": "Oregon",
                            "townName": "Tualatin",
                            "country": "US"
                          }
                        }
                      ],
                      "anualIncome": "100"
                    }
                  }
                bodyMediaType: application/jso
                outputMediaType: application/json
                resultType: java.lang.String
        - removeHeaders:
            id: removeHeaders-3f2d
            pattern: '*'
        - setHeader:
            id: setHeader-f13a
            description: Servicer Id
            name: servicerId
            expression:
              constant:
                id: constant-e191
                expression: mambu
        - setHeader:
            id: setHeader-b3c2
            description: Authorization
            name: Authorization
            expression:
              simple:
                id: simple-10ab
                expression: Bearer ${exchangeProperty.accessToken}
        - log:
            id: log-8f05
            message: ${headers}
        - to:
            id: to-4108
            uri: https
            parameters:
              httpUri: >-
                portx-oba-proc-api.dev.demobank.tenants.portx.io/portx-oba-proc-api/1.0/persons
              httpMethod: POST
        - log:
            id: log-4f3b
            message: Person Created
        - transform:
            id: transform-a62e
            expression:
              datasonnet:
                id: datasonnet-10f0
                expression: |-
                  { "dummy" : 
                      {
                    "uSDocumentedIndicator": true,
                    "identifiers": [
                      {
                        "number": "111111111",
                        "schemeName": "SocialSecurityNumber",
                        "issuer": "US",
                        "issueDate": "2022-04-17",
                        "expirationDate": "2022-04-17"
                      }
                    ],
                    "name": payload.name,
                    "shortName": "Jane Birkin",
                    "relatedParties": [
                      {
                        "partyId": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                        "partyType": "Person",
                        "partyName": "Jane Birkin",
                        "partyRelationType": "Owner",
                        "ownershipPercentage": "0.7"
                      }
                    ],
                    "postalAddresses": [
                      {
                        "addressType": "Postal",
                        "addressPurpose": "Billing",
                        "primaryIndicator": true,
                        "department": "A",
                        "subDepartment": "B",
                        "streetName": "Main Street",
                        "firstCrossStreetName": "Elm Street",
                        "secondCrossStreetName": "Oak Street",
                        "buildingNumber": "123",
                        "buildingName": "Chicago Tower",
                        "floor": "10",
                        "postBox": "CHI456",
                        "room": "22",
                        "postCode": "60601",
                        "townName": "Chicago",
                        "townLocationName": "Cook",
                        "districtName": "Illinois",
                        "countrySubDivision": "Cook County",
                        "countrySubDivisionCode": "US-IL",
                        "country": "US",
                        "addressLine": [
                          "123 Main Street, Suite 23"
                        ]
                      }
                    ],
                    "residenceType": "Domestic",
                    "taxInformation": {
                      "tIN": "111-22-3333",
                      "taxIdType": "SSN",
                      "tINStatus": "Valid",
                      "taxStatus": "Valid",
                      "forms": [
                        {
                          "formName": "W-9",
                          "expirationDate": "2022-04-17"
                        }
                      ],
                      "regulations": [
                        {
                          "name": "Chapter4",
                          "section": "1471"
                        }
                      ],
                      "withholdings": [
                        {
                          "withholdingTaxType": "NonResidentAlienTax",
                          "withholdingRate": "0.7",
                          "withholdingAmount": "100"
                        }
                      ],
                      "countrySubDivision": "Oregon",
                      "countrySubDivisionCode": "AR-B",
                      "country": "US",
                      "supplementaryData": {}
                    },
                    "powerOfAttorney": {
                      "jurisdiction": {
                        "countrySubdivision": "Oregon",
                        "townName": "Tualatin",
                        "country": "US"
                      },
                      "documentId": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                      "documentReference": "string",
                      "version": "string",
                      "signOffDate": "2022-04-17",
                      "issueDate": "2022-04-17",
                      "purpose": "string",
                      "fromDateTime": "2022-04-17T08:00:00Z",
                      "upToDateTime": "2022-04-17T08:00:00Z",
                      "authorizedPerson": "5fb9d4d6-1a3c-11ed-861d-0242ac120002",
                      "authorizedAccount": "0dd926fe-1ca2-11ed-861d-0242ac120002"
                    },
                    "supplementaryData": {},
                    "restrictions": [
                      {
                        "name": "externalTransferAllowed",
                        "restrictionPurpose": "This is a description.",
                        "validFrom": "2022-04-17",
                        "validUntil": "2022-04-17"
                      }
                    ],
                    "placeAndDateOfBirth": {
                      "countrySubdivision": "Oregon",
                      "townName": "Tualatin",
                      "country": "US",
                      "birthDate": "2022-04-17"
                    },
                    "contact": {
                      "structuredName": {
                        "firstName": "Jane",
                        "lastName": "Birkin"

                      },
                      "name": "Jane Birkin",
                      "phones": [
                        {
                          "number": "+1-415-731359",
                          "extension": "strin",
                          "phoneType": "string",
                          "phonePurpose": "string",
                          "primaryIndicator": true,
                          "preferredHourOfDay": {
                            "hour": "12",
                            "timeZone": "Pacific"
                          }
                        }
                      ],
                      "emails": [
                        {
                          "emailAddress": "string",
                          "emailPurpose": "Statements",
                          "primaryIndicator": true
                        }
                      ],
                      "jobTitle": "Head of Documentation",
                      "department": "Sales",
                      "preferredMethod": "Email",
                      "preferredLanguage": "English"
                    },
                    "headOfHousehold": true,
                    "civilStatus": "Single",
                    "structuredName": {
                      "firstName": "Jane",
                      "middleName": "J",
                      "lastName": "Birkin"
                    },
                    "gender": "Male",
                    "profession": "Technology",
                    "jobTitle": "Head of Documentation",
                    "residentialStatus": "Permanent",
                    "minorIndicator": true,
                    "citizenships": [
                      {
                        "country": "US"
                      }
                    ],
                    "countryOfResidence": "US",
                    "profile": {
                      "riskLevel": "Permanent",
                      "creditReview": {
                        "frequency": {
                          "cycle": "Monthly",
                          "every": 999
                        },
                        "lastReviewDate": "2022-04-17T08:00:00Z",
                        "nextReviewDate": "2022-04-17T08:00:00Z",
                        "creditQuality": "UpperMediumGrade",
                        "creditScore": 0
                      },
                      "creditBureauReportCode": "string",
                      "previousFinancialInstitution": "Jane Birkin",
                      "referredByWhom": "Jane Birkin",
                      "moneyLaunderingCheck": "AuthorizedCredit",
                      "knowYourCustomerCheck": "Ordinary",
                      "timeAtCurrentAddress": {
                        "unit": "Months",
                        "value": 999
                      },
                      "sourceOfWealth": "This is a description.",
                      "politicalAffiliation": "string",
                      "lostCustomerDate": "2022-04-17",
                      "lostCustomerReason": "Deceased",
                      "customerConductClassification": "string",
                      "familyMedicalInsuranceIndicator": true,
                      "salaryRange": {
                        "minAmount": "100",
                        "maxAmount": "100"
                      },
                      "employmentStatus": "string",
                      "vIPStatus": "Elite",
                      "employments": [
                        {
                          "employingPartyName": "Jane Birkin",
                          "jobTitle": "Head of Documentation",
                          "employeeTerminationIndicator": false,
                          "lengthOfEmployment": {
                            "unit": "Months",
                            "value": 999
                          },
                          "endDate": "2022-04-17",
                          "place": {
                            "countrySubdivision": "Oregon",
                            "townName": "Tualatin",
                            "country": "US"
                          }
                        }
                      ],
                      "anualIncome": "100"
                    }
                  }
                  }
- route:
    id: route-4ff4
    description: Generate Token
    nodePrefixId: route-1c6
    from:
      id: from-7228
      uri: direct
      parameters:
        name: generate-token
      steps:
        - log:
            id: log-132c
            message: Generating Token
        - removeHeaders:
            id: removeHeaders-924a
            pattern: '*'
        - setHeader:
            id: setHeader-c353
            description: Content Type
            name: Content-Type
            expression:
              constant:
                id: constant-7d59
                expression: application/x-www-form-urlencoded
        - setBody:
            id: setBody-512c
            expression:
              simple:
                id: simple-f2fa
                expression: >-
                  client_id={{clientId}}&scope={{scope}}&grant_type=client_credentials&client_secret={{clientSecret}}
        - to:
            id: to-e30c
            disabled: false
            uri: https
            pattern: InOut
            parameters:
              httpUri: '{{accessTokenUrl}}'
              httpMethod: POST
              bridgeEndpoint: false
        - setProperty:
            id: setProperty-ed61
            description: Access Token
            name: accessToken
            expression:
              datasonnet:
                id: datasonnet-adbc
                expression: payload["access_token"]
                resultType: java.lang.String
- route:
    id: route-64d3
    description: Get Person By Name
    nodePrefixId: route-157
    from:
      id: from-22c9
      uri: direct
      parameters:
        name: get-person-by-name
      steps:
        - log:
            id: log-0d59
            message: ${exchangeProperty.requestPayload}
        - setHeader:
            id: setHeader-48ff
            description: Servicer Id
            name: servicerId
            expression:
              constant:
                id: constant-ff7b
                expression: mambu
        - setHeader:
            id: setHeader-b3c2
            description: Authorization
            name: Authorization
            expression:
              simple:
                id: simple-10ab
                expression: Bearer ${exchangeProperty.accessToken}
        - log:
            id: log-ffcb
            message: ${headers}
        - toD:
            id: toD-fc4f
            description: Get Person by Name
            uri: >-
              https://portx-oba-proc-api.dev.demobank.tenants.portx.io/portx-oba-proc-api/1.0/persons?firstName.eq=${exchangeProperty.requestPayload['name']}&lastName.eq=LASTNAME
            pattern: InOnly
        - log:
            id: log-4850
            message: ${body}
- routeConfiguration: {}
